<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Role Test Report Viewer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            padding: 20px;
            min-height: 100vh;
        }
        h1 { color: #58a6ff; margin-bottom: 10px; font-size: 1.8em; }
        .subtitle { color: #8b949e; margin-bottom: 20px; font-size: 0.9em; }
        .stats-container { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .stat-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 15px 20px;
            min-width: 120px;
        }
        .stat-card h3 { font-size: 0.75em; color: #8b949e; text-transform: uppercase; margin-bottom: 5px; }
        .stat-card .value { font-size: 1.5em; font-weight: bold; }
        .stat-card.accessible .value { color: #f85149; }
        .stat-card.redirect .value { color: #3fb950; }
        .stat-card.denied .value { color: #d29922; }
        .stat-card.error .value { color: #8b949e; }
        .stat-card.total .value { color: #58a6ff; }
        .filters {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .filters h3 { color: #58a6ff; margin-bottom: 15px; font-size: 1em; }
        .filter-row { display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { font-size: 0.8em; color: #8b949e; }
        .filter-group input, .filter-group select {
            background: #0d1117;
            border: 1px solid #30363d;
            color: #c9d1d9;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9em;
        }
        .filter-group input:focus, .filter-group select:focus { outline: none; border-color: #58a6ff; }
        .filter-group input[type="text"] { min-width: 300px; }
        .btn {
            background: #21262d;
            border: 1px solid #30363d;
            color: #c9d1d9;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        .btn:hover { background: #30363d; }
        .btn-primary { background: #238636; border-color: #238636; }
        .btn-primary:hover { background: #2ea043; }
        .table-container {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            overflow: hidden;
        }
        .table-scroll { overflow-x: auto; max-height: 70vh; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        th {
            background: #21262d;
            color: #58a6ff;
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid #30363d;
            cursor: pointer;
        }
        th:hover { background: #30363d; }
        td { padding: 10px; border-bottom: 1px solid #21262d; vertical-align: middle; }
        tr:hover { background: #1c2128; }
        .method {
            font-weight: bold;
            font-family: 'Consolas', monospace;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            display: inline-block;
        }
        .method-GET { background: #238636; color: #fff; }
        .method-POST { background: #1f6feb; color: #fff; }
        .method-OPTIONS { background: #6e7681; color: #fff; }
        .method-PATCH { background: #a371f7; color: #fff; }
        .method-PUT { background: #d29922; color: #fff; }
        .method-DELETE { background: #f85149; color: #fff; }
        .url {
            font-family: 'Consolas', monospace;
            font-size: 0.85em;
            color: #8b949e;
            max-width: 500px;
            word-break: break-all;
        }
        .status {
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.8em;
            text-align: center;
            display: inline-block;
            min-width: 90px;
        }
        .status-ACCESSIBLE { background: #f8514933; color: #f85149; border: 1px solid #f85149; }
        .status-REDIRECT { background: #3fb95033; color: #3fb950; border: 1px solid #3fb950; }
        .status-DENIED { background: #d2992233; color: #d29922; border: 1px solid #d29922; }
        .status-ERROR { background: #8b949e33; color: #8b949e; border: 1px solid #8b949e; }
        .status-UNKNOWN { background: #6e768133; color: #6e7681; border: 1px solid #6e7681; }
        .results-info {
            padding: 10px 15px;
            background: #21262d;
            color: #8b949e;
            font-size: 0.85em;
            border-bottom: 1px solid #30363d;
        }
        .legend { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.85em; }
        .legend-color { width: 12px; height: 12px; border-radius: 3px; }
        .interesting-row { background: #2d1f1f !important; }
        .checkbox-group { display: flex; gap: 15px; flex-wrap: wrap; }
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-size: 0.85em;
        }
        .checkbox-group input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; }
        #fileInput { display: none; }
        .drop-zone {
            border: 2px dashed #30363d;
            border-radius: 8px;
            padding: 60px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        .drop-zone:hover, .drop-zone.dragover { border-color: #58a6ff; background: #161b22; }
        .drop-zone p { color: #8b949e; font-size: 1.1em; }
        .drop-zone .icon { font-size: 3em; margin-bottom: 10px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Role-Based Access Control Test Report</h1>
        <p class="subtitle">Penetration Testing - Authorization Matrix Analysis</p>
        
        <div id="dropZone" class="drop-zone">
            <div class="icon">üìÅ</div>
            <p>Drop CSV file here or click to browse</p>
            <input type="file" id="fileInput" accept=".csv">
        </div>

        <div id="reportContent" class="hidden">
            <div class="legend">
                <div class="legend-item"><div class="legend-color" style="background:#f85149;"></div> ACCESSIBLE (Potential Issue)</div>
                <div class="legend-item"><div class="legend-color" style="background:#3fb950;"></div> REDIRECT (Protected)</div>
                <div class="legend-item"><div class="legend-color" style="background:#d29922;"></div> DENIED (Forbidden)</div>
                <div class="legend-item"><div class="legend-color" style="background:#8b949e;"></div> ERROR</div>
                <div class="legend-item"><div class="legend-color" style="background:#6e7681;"></div> UNKNOWN</div>
            </div>

            <div class="stats-container" id="statsContainer"></div>

            <div class="filters">
                <h3>üîç Filters</h3>
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Search URL</label>
                        <input type="text" id="searchUrl" placeholder="Filter by URL...">
                    </div>
                    <div class="filter-group">
                        <label>Method</label>
                        <select id="filterMethod"></select>
                    </div>
                    <div id="roleFiltersContainer"></div>
                </div>
                <div class="filter-row" style="margin-top: 15px;">
                    <div class="filter-group">
                        <label>Quick Filters</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" id="showInteresting"> Interesting Only (Unauth ACCESSIBLE)</label>
                            <label><input type="checkbox" id="hideOptions"> Hide OPTIONS</label>
                        </div>
                    </div>
                    <button class="btn" id="resetBtn">Reset Filters</button>
                    <button class="btn btn-primary" id="exportBtn">Export Filtered CSV</button>
                    <button class="btn" id="loadNewBtn">Load New File</button>
                </div>
            </div>

            <div class="table-container">
                <div class="results-info" id="resultsInfo">Loading...</div>
                <div class="table-scroll">
                    <table>
                        <thead id="tableHead"></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let data = [];
        let headers = [];
        let filteredData = [];
        let sortColumn = null;
        let sortDirection = 'asc';

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const reportContent = document.getElementById('reportContent');

        // File handling
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.csv')) loadFile(file);
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) loadFile(e.target.files[0]);
        });

        document.getElementById('resetBtn').addEventListener('click', resetFilters);
        document.getElementById('exportBtn').addEventListener('click', exportFiltered);
        document.getElementById('loadNewBtn').addEventListener('click', () => {
            dropZone.classList.remove('hidden');
            reportContent.classList.add('hidden');
            fileInput.value = '';
        });

        function loadFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                parseCSV(e.target.result);
                dropZone.classList.add('hidden');
                reportContent.classList.remove('hidden');
            };
            reader.readAsText(file);
        }

        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            headers = parseCSVLine(lines[0]);
            data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((h, idx) => row[h] = values[idx]);
                    data.push(row);
                }
            }
            
            initializeUI();
            applyFilters();
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        function initializeUI() {
            // Method filter
            const methods = [...new Set(data.map(r => r.Method))].sort();
            const methodSelect = document.getElementById('filterMethod');
            methodSelect.innerHTML = '<option value="">All Methods</option>' + 
                methods.map(m => `<option value="${m}">${m}</option>`).join('');
            methodSelect.addEventListener('change', applyFilters);

            // Role filters
            const roleContainer = document.getElementById('roleFiltersContainer');
            roleContainer.innerHTML = '';
            const roleColumns = headers.filter(h => h !== 'Method' && h !== 'URL');
            
            roleColumns.forEach(role => {
                const statuses = [...new Set(data.map(r => r[role]))].sort();
                const div = document.createElement('div');
                div.className = 'filter-group';
                div.innerHTML = `
                    <label>${role}</label>
                    <select id="filter_${role.replace(/\s/g, '_')}">
                        <option value="">All</option>
                        ${statuses.map(s => `<option value="${s}">${s}</option>`).join('')}
                    </select>
                `;
                roleContainer.appendChild(div);
                div.querySelector('select').addEventListener('change', applyFilters);
            });

            // Table header
            document.getElementById('tableHead').innerHTML = `<tr>
                <th>#</th>
                ${headers.map(h => `<th data-col="${h}">${h} ‚áÖ</th>`).join('')}
            </tr>`;
            
            document.querySelectorAll('#tableHead th[data-col]').forEach(th => {
                th.addEventListener('click', () => sortBy(th.dataset.col));
            });

            // Other listeners
            document.getElementById('searchUrl').addEventListener('input', applyFilters);
            document.getElementById('showInteresting').addEventListener('change', applyFilters);
            document.getElementById('hideOptions').addEventListener('change', applyFilters);
        }

        function applyFilters() {
            const searchUrl = document.getElementById('searchUrl').value.toLowerCase();
            const filterMethod = document.getElementById('filterMethod').value;
            const showInteresting = document.getElementById('showInteresting').checked;
            const hideOptions = document.getElementById('hideOptions').checked;
            
            const roleColumns = headers.filter(h => h !== 'Method' && h !== 'URL');
            const roleFilters = {};
            roleColumns.forEach(role => {
                const el = document.getElementById(`filter_${role.replace(/\s/g, '_')}`);
                if (el) roleFilters[role] = el.value;
            });

            filteredData = data.filter(row => {
                if (searchUrl && !row.URL.toLowerCase().includes(searchUrl)) return false;
                if (filterMethod && row.Method !== filterMethod) return false;
                if (hideOptions && row.Method === 'OPTIONS') return false;
                
                for (const [role, value] of Object.entries(roleFilters)) {
                    if (value && row[role] !== value) return false;
                }
                
                if (showInteresting) {
                    const unauthCol = headers.find(h => h.toLowerCase().includes('unauth'));
                    if (unauthCol && row[unauthCol] !== 'ACCESSIBLE') return false;
                    if (row.Method === 'OPTIONS') return false;
                }
                
                return true;
            });

            if (sortColumn) {
                filteredData.sort((a, b) => {
                    const cmp = (a[sortColumn] || '').localeCompare(b[sortColumn] || '');
                    return sortDirection === 'asc' ? cmp : -cmp;
                });
            }

            renderTable();
            updateStats();
        }

        function sortBy(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            applyFilters();
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const roleColumns = headers.filter(h => h !== 'Method' && h !== 'URL');
            const unauthCol = headers.find(h => h.toLowerCase().includes('unauth'));
            
            tbody.innerHTML = filteredData.map((row, idx) => {
                const isInteresting = unauthCol && row[unauthCol] === 'ACCESSIBLE' && row.Method !== 'OPTIONS';
                
                return `<tr class="${isInteresting ? 'interesting-row' : ''}">
                    <td>${idx + 1}</td>
                    <td><span class="method method-${row.Method}">${row.Method}</span></td>
                    <td class="url">${escapeHtml(row.URL)}</td>
                    ${roleColumns.map(role => `<td><span class="status status-${row[role]}">${row[role]}</span></td>`).join('')}
                </tr>`;
            }).join('');

            document.getElementById('resultsInfo').textContent = 
                `Showing ${filteredData.length} of ${data.length} endpoints`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateStats() {
            const stats = document.getElementById('statsContainer');
            const unauthCol = headers.find(h => h.toLowerCase().includes('unauth'));
            
            let html = `<div class="stat-card total"><h3>Total</h3><div class="value">${filteredData.length}</div></div>`;
            
            if (unauthCol) {
                const counts = {};
                filteredData.forEach(row => {
                    counts[row[unauthCol]] = (counts[row[unauthCol]] || 0) + 1;
                });
                
                ['ACCESSIBLE', 'REDIRECT', 'DENIED', 'ERROR', 'UNKNOWN'].forEach(status => {
                    if (counts[status]) {
                        html += `<div class="stat-card ${status.toLowerCase()}">
                            <h3>${status}</h3>
                            <div class="value">${counts[status]}</div>
                        </div>`;
                    }
                });
            }
            
            stats.innerHTML = html;
        }

        function resetFilters() {
            document.getElementById('searchUrl').value = '';
            document.getElementById('filterMethod').value = '';
            document.getElementById('showInteresting').checked = false;
            document.getElementById('hideOptions').checked = false;
            
            headers.filter(h => h !== 'Method' && h !== 'URL').forEach(role => {
                const el = document.getElementById(`filter_${role.replace(/\s/g, '_')}`);
                if (el) el.value = '';
            });
            
            sortColumn = null;
            sortDirection = 'asc';
            applyFilters();
        }

        function exportFiltered() {
            let csv = headers.join(',') + '\n';
            filteredData.forEach(row => {
                csv += headers.map(h => {
                    const val = row[h] || '';
                    return val.includes(',') || val.includes('"') ? `"${val.replace(/"/g, '""')}"` : val;
                }).join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'filtered_role_test_report.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
